platform:
  id: {{platform:id}}
  organization: {{platform:organization}}
  account: {{platform:account}}
  region: {{platform:region}}
  name: {{platform:name}}
  alias: {{platform:alias}}
  environment: {{platform:environment}}
  version: {{platform:version}}
  domain: {{platform:domain}}
  tags: {}

release:
  common:
    id: {{deployment:id}}
    organization: {{deployment:organization}}
    account: {{deployment:account}}
    region: {{deployment:region}}
    name: {{deployment:team:name}}
    alias: {{deployment:team:alias}}
    environment: {{deployment:environment}}
    version: {{deployment:version}}
    domain: {{deployment:domain}}
    tags:
      "{{deployment:domain}}:billing": {{deployment:organization}}
      "{{deployment:domain}}:managed-by": {{deployment:organization}}
      "{{deployment:domain}}:account": {{deployment:account}}
      "{{deployment:domain}}:region": {{deployment:region}}
      "{{deployment:domain}}:name": {{deployment:team:name}}
      "{{deployment:domain}}:alias": {{deployment:team:alias}}
      {{#deployment:tags}}
      "{{key}}": "{{value}}"
      {{/deployment:tags}}

  vpc:
    name: {{deployment:id}}-vpc
    cidr: 10.0.0.0/16
    ipProtocol: ipv4_only
    natGateways: 2
    createInternetGateway: true
    availabilityZones:
      - {{deployment:region}}a
      - {{deployment:region}}b
      - {{deployment:region}}c
    enableDnsSupport: true
    enableDnsHostnames: true
    defaultInstanceTenancy: default
    securityGroups: [ ]
    subnets:
      - name: public
        cidrMask: 24
        reserved: false
        subnetType: public
        mapPublicIpOnLaunch: false
        tags:
          "{{deployment:domain}}:resource-type": subnet
          "{{deployment:domain}}:category": network
          "{{deployment:domain}}:type": public
          "{{deployment:domain}}:cidrMask": 24
          "{{deployment:domain}}:component": {{deployment:id}}-vpc
          "{{deployment:domain}}:organization": "{{deployment:organization}}"
          "{{deployment:domain}}:name": "{{deployment:team:name}}"
          "{{deployment:domain}}:alias": "{{deployment:team:alias}}"
          "karpenter.sh/discovery": {{deployment:id}}-vpc
      - name: private
        cidrMask: 24
        reserved: false
        subnetType: private_with_egress
        tags:
          "{{deployment:domain}}:resource-type": subnet
          "{{deployment:domain}}:category": network
          "{{deployment:domain}}:type": private_with_egress
          "{{deployment:domain}}:cidrMask": 24
          "{{deployment:domain}}:component": {{deployment:id}}-vpc
          "{{deployment:domain}}:organization": "{{deployment:organization}}"
          "{{deployment:domain}}:name": "{{deployment:team:name}}"
          "{{deployment:domain}}:alias": "{{deployment:team:alias}}"
          "karpenter.sh/discovery": {{deployment:id}}-vpc
    tags:
      "{{deployment:domain}}:resource-type": vpc
      "{{deployment:domain}}:category": network
      "{{deployment:domain}}:type": network
      "{{deployment:domain}}:cidrMask": 24
      "{{deployment:domain}}:component": {{deployment:id}}-vpc
      "{{deployment:domain}}:organization": "{{deployment:organization}}"
      "{{deployment:domain}}:name": "{{deployment:team:name}}"
      "{{deployment:domain}}:alias": "{{deployment:team:alias}}"

  eks:
    name: {{deployment:id}}-eks
    version: "1.34"
    endpointAccess: public_and_private
    prune: true
    bootstrapSelfManagedAddons: false
    vpcSubnetTypes:
      - public
      - private_with_egress
    rbac: eks/rbac.mustache
    tenancy: eks/tenancy.mustache
    nodeGroups: eks/node-groups.mustache
    addons: eks/addons.mustache
    sqs: eks/sqs.mustache
    observability: eks/observability.mustache
    loggingTypes:
      - api
      - audit
      - authenticator
      - controller_manager
      - scheduler
    annotations: { }
    labels:
      "{{deployment:domain}}/billing": {{deployment:organization}}
      "{{deployment:domain}}/managed-by": {{deployment:organization}}
      "{{deployment:domain}}/account": {{deployment:account}}
      "{{deployment:domain}}/region": {{deployment:region}}
      "{{deployment:domain}}/version": {{deployment:version}}
      "{{deployment:domain}}/name": "{{deployment:team:name}}"
      "{{deployment:domain}}/alias": "{{deployment:team:alias}}"
    tags:
      "{{deployment:domain}}:resource-type": eks
      "{{deployment:domain}}:category": eks
      "{{deployment:domain}}:type": backstage
      "{{deployment:domain}}:component": {{deployment:id}}-eks
      "{{deployment:domain}}:organization": "{{deployment:organization}}"
      "{{deployment:domain}}:name": "{{deployment:team:name}}"
      "{{deployment:domain}}:alias": "{{deployment:team:alias}}"
      "karpenter.sh/discovery": {{deployment:id}}-vpc

  database:
    version: "16.4"
    name: {{deployment:id}}-backstage-db
    databaseName: backstage
    storageType: aurora_iopt1
    enableDataApi: true
    deletionProtection: true
    removalPolicy: retain
    credentials:
      name: {{deployment:id}}-backstage-db-credentials
      description: Backstage PostgreSQL database credentials
      username: backstage_admin
      password:
        length: 32
        excludeNumbers: false
        excludeLowercase: false
        excludeUppercase: false
        includeSpace: false
      removalPolicy: retain
      tags:
        "{{deployment:domain}}:resource-type": secret
        "{{deployment:domain}}:category": database
        "{{deployment:domain}}:component": {{deployment:id}}-backstage-db
    writer:
      name: backstage-writer
      allowMajorVersionUpgrade: false
      autoMinorVersionUpgrade: true
      publiclyAccessible: false
      performanceInsights:
        enabled: true
        retention: default
    readers: []
    tags:
      "{{deployment:domain}}:resource-type": rds
      "{{deployment:domain}}:category": database
      "{{deployment:domain}}:type": postgresql
      "{{deployment:domain}}:component": {{deployment:id}}-backstage-db
      "{{deployment:domain}}:organization": "{{deployment:organization}}"
      "{{deployment:domain}}:name": "{{deployment:team:name}}"
      "{{deployment:domain}}:alias": "{{deployment:team:alias}}"

  githubOAuth:
    name: {{deployment:id}}-backstage-github-oauth
    description: GitHub OAuth credentials for Backstage authentication
    username: github_oauth
    password:
      length: 64
      excludeNumbers: false
      excludeLowercase: false
      excludeUppercase: false
      includeSpace: false
    removalPolicy: retain
    tags:
      "{{deployment:domain}}:resource-type": secret
      "{{deployment:domain}}:category": authentication
      "{{deployment:domain}}:component": {{deployment:id}}-backstage-github-oauth
      "{{deployment:domain}}:organization": "{{deployment:organization}}"
      "{{deployment:domain}}:name": "{{deployment:team:name}}"
      "{{deployment:domain}}:alias": "{{deployment:team:alias}}"

  serviceAccount:
    metadata:
      name: {{deployment:id}}-backstage-sa
      namespace: backstage
      labels:
        "{{deployment:domain}}/resource-type": service-account
        "{{deployment:domain}}/category": compute
        "{{deployment:domain}}/type": backstage
        "{{deployment:domain}}/component": backstage
        "{{deployment:domain}}/organization": "{{deployment:organization}}"
        "{{deployment:domain}}/name": "{{deployment:team:name}}"
        "{{deployment:domain}}/alias": "{{deployment:team:alias}}"
      annotations: { }
    role:
      name: {{deployment:id}}-backstage-sa-role
      principal:
        type: service
        value: ec2.amazonaws.com
      managedPolicyNames: [ ]
      customPolicies:
        - name: {{deployment:id}}-backstage-secret-access
          policy: policy/secret-access.mustache
          mappings:
            resources:
              - arn:aws:secretsmanager:{{deployment:region}}:{{deployment:account}}:secret:{{deployment:id}}-backstage-db-credentials*
              - arn:aws:secretsmanager:{{deployment:region}}:{{deployment:account}}:secret:{{deployment:id}}-backstage-github-oauth*
      tags:
        "{{deployment:domain}}:resource-type": role
        "{{deployment:domain}}:category": compute
        "{{deployment:domain}}:type": backstage
        "{{deployment:domain}}:component": {{deployment:id}}-backstage
        "{{deployment:domain}}:organization": "{{deployment:organization}}"
        "{{deployment:domain}}:name": "{{deployment:team:name}}"
        "{{deployment:domain}}:alias": "{{deployment:team:alias}}"

  certificate:
    domainName: "{{deployment:domain}}"
    validationMethod: DNS
    removalPolicy: retain
    tags:
      "{{deployment:domain}}:resource-type": certificate
      "{{deployment:domain}}:category": security
      "{{deployment:domain}}:type": tls
      "{{deployment:domain}}:component": {{deployment:id}}-backstage
      "{{deployment:domain}}:organization": "{{deployment:organization}}"
      "{{deployment:domain}}:name": "{{deployment:team:name}}"
      "{{deployment:domain}}:alias": "{{deployment:team:alias}}"

  dockerImage:
    name: {{deployment:id}}-backstage
    directory: ../backstage-ext
    dockerfile: Dockerfile
    platform: linux/amd64
    buildArgs: {}

  helm:
    name: backstage
    namespace: backstage
    release: backstage-{{deployment:team:alias}}
    repository: ""
    values: backstage/values.mustache
    version: "1.0.0"
