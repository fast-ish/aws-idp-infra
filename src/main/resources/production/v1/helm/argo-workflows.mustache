server:
  replicas: 2
  servicePort: 2746

  serviceAccount:
    create: true
    name: argo-server

  authModes:
    - sso

  sso:
    enabled: true
    issuer: https://argocd.{{domain}}/api/dex
    clientId:
      name: argo-workflows-sso
      key: client-id
    clientSecret:
      name: argo-workflows-sso
      key: client-secret
    redirectUrl: https://workflows.{{domain}}/oauth2/callback
    rbac:
      enabled: false
    scopes:
      - openid
      - profile
      - email
      - groups
    customGroupClaimName: groups

  extraArgs:
    - --secure=false
    - --access-control-allow-origin=https://workflows.{{domain}}

  ingress:
    enabled: true
    ingressClassName: alb
    annotations:
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/certificate-arn: "{{certificate.arn}}"
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS":443}]'
      alb.ingress.kubernetes.io/ssl-redirect: "443"
      alb.ingress.kubernetes.io/healthcheck-path: /
      alb.ingress.kubernetes.io/healthcheck-protocol: HTTP
      alb.ingress.kubernetes.io/backend-protocol: HTTP
      alb.ingress.kubernetes.io/group.name: argo
    hosts:
      - workflows.{{domain}}
    paths:
      - /
    pathType: Prefix

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  pdb:
    enabled: true
    minAvailable: 1

  securityContext:
    runAsNonRoot: true
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL

controller:
  replicas: 2

  serviceAccount:
    create: true
    name: argo-workflow-controller

  workflowNamespaces:
{{#workflowNamespaces}}
    - {{.}}
{{/workflowNamespaces}}

  workflowDefaults:
    spec:
      serviceAccountName: argo-workflow
      ttlStrategy:
        secondsAfterCompletion: 3600
        secondsAfterSuccess: 1800
        secondsAfterFailure: 86400
      podGC:
        strategy: OnWorkflowSuccess
        deleteDelayDuration: 5m
      securityContext:
        runAsNonRoot: true
        fsGroup: 1000
      retryStrategy:
        limit: 2
        retryPolicy: "OnError"
        backoff:
          duration: "10s"
          factor: 2
          maxDuration: "1m"
      podMetadata:
        labels:
          app.kubernetes.io/managed-by: argo-workflows
        annotations:
          prometheus.io/scrape: "true"
          prometheus.io/port: "9090"

  persistence:
    archive: true
    postgresql:
      host: "{{argoWorkflows.db.host}}"
      port: 5432
      database: "{{argoWorkflows.db.name}}"
      tableName: argo_workflows
      ssl: true
      sslMode: require
      userNameSecret:
        name: "argo-workflows-db-credentials"
        key: username
      passwordSecret:
        name: "argo-workflows-db-credentials"
        key: password

  metricsConfig:
    enabled: true
    port: 9090
    path: /metrics
    metricsTTL: 10m

  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  extraArgs:
    - --executor-image-pull-policy=IfNotPresent

  pdb:
    enabled: true
    minAvailable: 1

  securityContext:
    runAsNonRoot: true
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL

  parallelism: 20
  namespaceParallelism: 10
  resourceRateLimit:
    limit: 10
    burst: 5

artifactRepository:
  archiveLogs: true
  s3:
    bucket: "{{artifactBucket}}"
    region: "{{region}}"
    endpoint: s3.{{region}}.amazonaws.com
    useSDKCreds: true
    insecure: false
    keyFormat: "artifacts/{{`{{workflow.namespace}}`}}/{{`{{workflow.creationTimestamp.Y}}`}}/{{`{{workflow.creationTimestamp.m}}`}}/{{`{{workflow.name}}`}}/{{`{{pod.name}}`}}"

workflow:
  serviceAccount:
    create: true
    name: argo-workflow
  rbac:
    create: true

executor:
  resources:
    requests:
      cpu: 10m
      memory: 64Mi
    limits:
      cpu: 500m
      memory: 256Mi
  securityContext:
    runAsNonRoot: true
    readOnlyRootFilesystem: false
    allowPrivilegeEscalation: false

mainContainer:
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  securityContext:
    runAsNonRoot: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
        - ALL

useStaticCredentials: false
singleNamespace: false
createAggregateRoles: true

images:
  pullPolicy: IfNotPresent

priorityClassName: system-cluster-critical

extraObjects:
  - apiVersion: external-secrets.io/v1
    kind: ExternalSecret
    metadata:
      name: argo-workflows-db-credentials
      namespace: argo
      labels:
        app.kubernetes.io/managed-by: argo-workflows
    spec:
      refreshInterval: 1h
      secretStoreRef:
        name: aws-secrets-manager
        kind: ClusterSecretStore
      target:
        name: argo-workflows-db-credentials
        creationPolicy: Owner
      data:
        - secretKey: username
          remoteRef:
            key: {{argoWorkflows.db.secretName}}
            property: username
        - secretKey: password
          remoteRef:
            key: {{argoWorkflows.db.secretName}}
            property: password
  - apiVersion: v1
    kind: Secret
    metadata:
      name: argo-workflows-sso
      namespace: argo
      labels:
        app.kubernetes.io/managed-by: argo-workflows
    type: Opaque
    stringData:
      client-id: argo-workflows
      client-secret: "{{argoWorkflows.ssoClientSecret}}"
